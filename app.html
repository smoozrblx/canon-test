<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Produits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="The tool is used to manipulate products" name="description">
  <meta content="Product" name="keywords">

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="./style.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>


</head>
<body class="bg-gray-100 text-gray-900">

  <div id="app" class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Gestion des Produits</h1>

    <div v-if="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      [[ errorMessage ]]
    </div>

    <div
    v-if="showFormModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 relative z-50">
        <button
          @click="closeFormModal"
          class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
        >
          <i class="bi bi-x-lg"></i>
        </button>

        <h2 class="text-2xl font-semibold mb-6">
          [[ form.id ? "Modifier" : "Créer" ]] un produit
        </h2>

        <form @submit.prevent="form.id ? updateProduct() : createProduct()" class="space-y-6">
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code produit</label>
              <input v-model="form.product_code" class="input w-full" placeholder="Code produit" maxlength="8" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Statut du produit</label>
              <select v-model="form.product_status" class="input w-full" required>
                <option disabled value="">-- Sélectionner --</option>
                <option class="text-green-600">EN VENTE</option>
                <option class="text-indigo-700">NOUVEAU</option>
                <option class="text-orange-500">EMBARGO</option>
                <option class="text-yellow-500">FIN DE VIE</option>
                <option class="text-red-800">OBSOLETE</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du produit</label>
              <input v-model="form.product_name" class="input w-full" placeholder="Nom du produit" maxlength="100" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prix (€)</label>
              <input v-model.number="form.price" type="number" step="0.01" class="input w-full" placeholder="Prix (€)" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Poids (kg)</label>
              <input v-model.number="form.weight" type="number" step="0.1" class="input w-full" placeholder="Poids (kg)">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date de sortie</label>
              <input v-model="form.release_date" type="date" class="input w-full" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Disponibilité</label>
              <select v-model="form.is_available" class="input w-full">
                <option :value="true">Disponible</option>
                <option :value="false">Indisponible</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Créé par</label>
              <input v-model="form.meta_entered_by" class="input w-full" placeholder="Créé par">
            </div>

          </div>

          <div class="flex justify-end space-x-3">
            <button
              type="submit"
              class="px-5 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 transition"
            >
              [[ form.id ? "Mettre à jour" : "Créer" ]] le produit
            </button>

            <button
              type="button"
              @click="closeFormModal"
              class="px-5 py-2 rounded-md bg-gray-200 text-gray-800 text-sm font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300 transition"
            >
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="w-full bg-white p-4 shadow-md rounded-lg mb-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 font-sm text-sm">

      <div>
        <label for="filterOn" class="block text-sm font-medium text-gray-600">Filtres</label>
        <div class="flex items-center flex-row my-2">
          <input 
            v-model="filters.filterOn"
            type="checkbox"
            id="filterOn"
            class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <span class="text-sm text-gray-600 mx-2">Activer les filtres</span>
        </div>
      </div>
      <div>
        <label for="product_code" class="block text-sm font-sm text-gray-600 py-0.5">Code Produit</label>
        <input 
          v-model="filters.product_code"
          type="text"
          id="product_code"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
          placeholder="Filtrer par code"
        />
      </div>
      <div>
        <label for="product_name" class="block text-sm font-sm text-gray-600 py-0.5">Nom Produit</label>
        <input 
          v-model="filters.product_name"
          type="text"
          id="product_name"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
          placeholder="Filtrer par nom"
        />
      </div>
      <div>
        <label for="product_status" class="block text-sm font-sm text-gray-600 py-0.5">Statut</label>
        <input 
          v-model="filters.product_status"
          type="text"
          id="product_status"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
          placeholder="Filtrer par statut"
        />
      </div>
      <div>
        <label for="after_date" class="block text-sm font-sm text-gray-600 py-0.5">Sortie après</label>
        <input 
          v-model="filters.release_date_after"
          type="date"
          id="after_date"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
      </div>
      <div>
        <label for="before_date" class="block text-sm font-sm text-gray-600 py-0.5">Sortie avant</label>
        <input 
          v-model="filters.release_date_before"
          type="date"
          id="before_date"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
      </div>
      <div>
        <label for="on_date" class="block text-sm font-sm text-gray-600 py-0.5">Sortie le</label>
        <input 
          v-model="filters.release_date_on"
          type="date"
          id="on_date"
          :disabled="!filters.filterOn"
          class="w-full p-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
        />
      </div>

      <div>
        <label for="dispo" class="block text-sm font-medium text-gray-600">Disponibilité</label>
        <div class="flex items-center flex-row my-2">
          <input 
            v-model="filters.dispo"
            type="checkbox"
            id="dispo"
            :disabled="!filters.filterOn"
            class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <span class="text-sm text-gray-600 mx-2">Disponible</span>
          <button
            type="button"
            @click="resetDisponibilityFilter"
            class="text-blue-600 text-sm"
          >
            Réinitialiser Disponibilité
          </button>
        </div>
      </div>
      <div>
        <label for="price_slider" class="block text-sm font-medium text-gray-600">Prix (€)</label>
        <div class="relative w-full">
          <div class="slider-container">
            <div ref="priceSlider"></div>
            <div class="flex justify-between text-sm text-gray-600">
              <span>[[ filters.price_range[0] ]]</span>
              <span>[[ filters.price_range[1] ]]</span>
            </div>
          </div>
        </div>
      </div>
      
      <div>
        <label for="weight_slider" class="block text-sm font-medium text-gray-600">Poids (kg)</label>
        <div class="relative w-full">
          <div class="slider-container">
            <div ref="weightSlider"></div>
            <div class="flex justify-between text-sm text-gray-600">
              <span>[[ filters.weight_range[0] ]]</span>
              <span>[[ filters.weight_range[1] ]]</span>
            </div>
          </div>
        </div>
      </div>
      
    </div>
        

    <div class="overflow-x-auto bg-white shadow rounded">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100 text-left text-sm font-semibold text-gray-700">
          <tr>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('product_status')">
              <div class="flex items-center space-x-1">
                <span>Statut</span>
                <i :class="sortBy === 'product_status' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('product_code')">
              <div class="flex items-center space-x-1">
                <span>Code</span>
                <i :class="sortBy === 'product_code' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('product_name')">
              <div class="flex items-center space-x-1">
                <span>Nom</span>
                <i :class="sortBy === 'product_name' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('release_date')">
              <div class="flex items-center space-x-1">
                <span>Date de sortie</span>
                <i :class="sortBy === 'release_date' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('is_available')">
              <div class="flex items-center space-x-1">
                <span>Disponibilité</span>
                <i :class="sortBy === 'is_available' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>`
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('weight')">
              <div class="flex items-center space-x-1">
                <span>Poids</span>
                <i :class="sortBy === 'weight' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2 cursor-pointer" @click="sortTable('price')">
              <div class="flex items-center space-x-1">
                <span>Prix</span>
                <i :class="sortBy === 'price' ? (sortOrder === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down') : 'bi bi-arrow-up-down'"></i>
              </div>
            </th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        
        <tbody class="divide-y divide-gray-100 text-sm">
          <tr v-for="product in filteredAndSortedProducts" :key="product.id">
            <td class="px-4 py-2">
              <span v-bind:class="{
                'bg-green-200 text-green-600': product.product_status === 'EN VENTE',
                'bg-indigo-200 text-indigo-700': product.product_status === 'NOUVEAU',
                'bg-orange-200 text-orange-500': product.product_status === 'EMBARGO',
                'bg-yellow-200 text-yellow-500': product.product_status === 'FIN DE VIE',
                'bg-red-200 text-red-800': product.product_status === 'OBSOLETE'
              }" class="inline-block px-3 py-1 rounded-full text-sm font-medium">
                [[ product.product_status ]]
              </span>
            </td>   
            <td class="px-4 py-2">
              <span class="inline-block bg-gray-100 text-gray-800 text-sm font-mono px-2 py-1 rounded-md">
                [[ product.product_code ]]
              </span>
            </td>

            <td class="px-4 py-2 text-sm font-medium text-gray-900">
              [[ product.product_name ]]
            </td>

            <td class="px-4 py-2 text-sm text-gray-700 flex items-center space-x-2">
              <i class="bi bi-calendar-event text-purple-600"></i>
              <span>
                [[ new Date(product.release_date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' }) ]]
              </span>
            </td>

            <td class="px-4 py-2">
              <span :class="product.is_available ? 'text-green-600' : 'text-red-500'" class="inline-flex items-center space-x-2">
                <i v-if="product.is_available" class="fas fa-check-circle text-green-600"></i>
                <i v-else class="fas fa-times-circle text-red-500"></i>
                <span>[[ product.is_available ? 'Disponible' : 'Indisponible' ]]</span>
              </span>
            </td>            
            <td class="px-4 py-2">
              <span class="inline-flex items-center bg-blue-100 text-blue-700 text-sm font-medium px-2 py-1 rounded">
                <i class="bi bi-box me-1"></i>
                [[ product.weight !== null && product.weight !== undefined ? product.weight + ' kg' : '–' ]]
              </span>
            </td>
            <td class="px-4 py-2">
              <span class="inline-flex items-center text-green-600 text-sm font-semibold border-2 px-1 py-1 rounded">
                [[ product.price ]] €
              </span>
            </td>
            <td class="px-4 py-2 space-x-2">
              <button
                @click="editProduct(product)"
                class="px-3 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
              >
                <i class="bi bi-pencil-fill mr-1"></i> Modifier
              </button>
            
              <button
                @click="deleteProduct(product.id)"
                class="px-3 py-1 rounded-md text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200 transition"
              >
                <i class="bi bi-trash-fill mr-1"></i> Supprimer
              </button>
            </td>            
          </tr>
          <tr @click="openCreateForm" class="cursor-pointer hover:bg-blue-50 transition">
            <td colspan="999" class="text-center py-2">
              <div class="inline-flex items-center justify-center text-blue-600 text-md font-semibold">
                <i class="bi bi-plus-circle mr-2 text-2xl"></i>
                Ajouter un produit
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  


  <script>
    const app = Vue.createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          products: [],
          errorMessage: '',
          showFormModal: false,
          sortBy: 'product_name',
          sortOrder: 'asc',
          filtersVisible: false,
          priceMax: 1000,
          weightMax: 50,
          filters: {
            filterOn: false,
            product_code: '',
            product_name: '',
            product_status: '',
            release_date_after: '',
            release_date_before: '',
            release_date_on: '',
            dispo: null,
            price_range: [0, 100],
            weight_range: [0, 10],
          },
          form: {
            id: null,
            product_code: '',
            product_status: '',
            product_name: '',
            price: null,
            weight: null,
            release_date: '',
            is_available: true,
            meta_entered_by: ''
          }
        };
      },
      mounted() {
        this.fetchProducts();

        const priceSlider = this.$refs.priceSlider;
        noUiSlider.create(priceSlider, {
          start: this.filters.price_range,
          connect: true,
          range: {
            min: 0,
            max: this.priceMax,
          },
          step: 0.01,
        });

        priceSlider.noUiSlider.on('update', (values) => {
          // Update Vue data only if values change
          const newPriceRange = values.map(value => parseFloat(value));
          if (newPriceRange[0] !== this.filters.price_range[0] || newPriceRange[1] !== this.filters.price_range[1]) {
            this.filters.price_range = newPriceRange;
          }
        });

        // Initialize weight range slider
        const weightSlider = this.$refs.weightSlider;
        noUiSlider.create(weightSlider, {
          start: this.filters.weight_range,
          connect: true,
          range: {
            min: 0,
            max: this.weightMax,
          },
          step: 0.1,
        });

        weightSlider.noUiSlider.on('update', (values) => {
          // Update Vue data only if values change
          const newWeightRange = values.map(value => parseFloat(value));
          if (newWeightRange[0] !== this.filters.weight_range[0] || newWeightRange[1] !== this.filters.weight_range[1]) {
            this.filters.weight_range = newWeightRange;
          }
        });

        this.filters.price_range = [0, this.priceMax];
        this.filters.weight_range = [0, this.weightMax];

      },
      methods: {
        sortTable(field) {
          if (this.sortBy === field) {
            this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortBy = field;
            this.sortOrder = 'asc';
          }
        },
        async fetchProducts() {
          try {
            const response = await fetch("https://canontestexercise.azurewebsites.net/api/v1/product/");
            const data = await response.json();
            this.products = data;
            this.updateMaxValues();
            this.updateSliders();
          } catch (error) {
            this.errorMessage = "Erreur lors du chargement des produits.";
          }
        },
        async openCreateForm() {
          this.resetForm();
          this.showFormModal = true;
        },
        async createProduct() {
          this.errorMessage = '';
          try {
            const response = await fetch("https://canontestexercise.azurewebsites.net/api/v1/product/", {
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(JSON.stringify(errorData));
            }

            this.fetchProducts();
            this.resetForm();
          } catch (error) {
            this.errorMessage = "Erreur à la création: " + error.message;
          }
        },
        async updateProduct() {
          this.errorMessage = '';
          try {
            const response = await fetch(`https://canontestexercise.azurewebsites.net/api/v1/product/${this.form.id}/`, {
              method: "PUT",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(JSON.stringify(errorData));
            }

            this.fetchProducts();
            this.resetForm();
          } catch (error) {
            this.errorMessage = "Erreur à la mise à jour: " + error.message;
          }
        },
        async deleteProduct(id) {
          if (!confirm("Supprimer ce produit ?")) return;

          this.errorMessage = '';
          try {
            const response = await fetch(`https://canontestexercise.azurewebsites.net/api/v1/product/${id}/`, {
              method: "DELETE"
            });

            if (!response.ok) {
              throw new Error("Échec de la suppression.");
            }

            this.fetchProducts();
          } catch (error) {
            this.errorMessage = "Erreur à la suppression: " + error.message;
          }
        },
        editProduct(product) {
          this.form = { ...product };
          this.showFormModal = true;
        },
        closeFormModal() {
          this.showFormModal = false;
        },
        resetDisponibilityFilter() {
          this.filters.dispo = null;
        },
        resetForm() {
          this.form = {
            id: null,
            product_code: '',
            product_status: '',
            product_name: '',
            price: null,
            weight: null,
            release_date: '',
            is_available: true,
            meta_entered_by: ''
          };
          this.errorMessage = '';
        },
        updateMaxValues() {
          this.priceMax = this.products.length ? Math.max(...this.products.map(product => product.price)) : 1000;
          this.weightMax = this.products.length ? Math.max(...this.products.map(product => product.weight)) : 50;
        },
        updateSliders() {
          // Update the price slider
          const priceSlider = this.$refs.priceSlider;
          if (priceSlider && priceSlider.noUiSlider) {
            priceSlider.noUiSlider.updateOptions({
              range: {
                min: 0,
                max: this.priceMax,
              },
            });
            priceSlider.noUiSlider.set(this.filters.price_range);
          }

          // Update the weight slider
          const weightSlider = this.$refs.weightSlider;
          if (weightSlider && weightSlider.noUiSlider) {
            weightSlider.noUiSlider.updateOptions({
              range: {
                min: 0,
                max: this.weightMax,
              },
            });
            weightSlider.noUiSlider.set(this.filters.weight_range);
          }
        },
      },
      watch: {
        'filters.price_range': function(newVal) {
          const priceSlider = this.$refs.priceSlider;
          priceSlider.noUiSlider.set(newVal);
        },
        'filters.weight_range': function(newVal) {
          const weightSlider = this.$refs.weightSlider;
          weightSlider.noUiSlider.set(newVal);
        }
      },
      computed: {
        filteredAndSortedProducts() {
          let filteredProducts = this.filters.filterOn ? this.products.filter((product) => {
            if (this.filters.product_code && !product.product_code.toLowerCase().includes(this.filters.product_code.toLowerCase())) {
              return false;
            }
            if (this.filters.product_name && !product.product_name.toLowerCase().includes(this.filters.product_name.toLowerCase())) {
              return false;
            }
            if (this.filters.product_status && !product.product_status.toLowerCase().includes(this.filters.product_status.toLowerCase())) {
              return false;
            }
            if (this.filters.dispo != null && product.is_available != this.filters.dispo) {
              return false;
            }
            if (this.filters.release_date_after && new Date(product.release_date) < new Date(this.filters.release_date_after)) {
              return false;
            }
            if (this.filters.release_date_before && new Date(product.release_date) > new Date(this.filters.release_date_before)) {
              return false;
            }
            if (this.filters.release_date_on && product.release_date !== this.filters.release_date_on) {
              return false;
            }
            if (product.price < this.filters.price_range[0] || product.price > this.filters.price_range[1]) {
              return false;
            }
            if (product.weight < this.filters.weight_range[0] || product.weight > this.filters.weight_range[1]) {
              return false;
            }
            return true;
          }) : this.products;
          return filteredProducts.sort((a, b) => {
            const aValue = a[this.sortBy];
            const bValue = b[this.sortBy];

            if (typeof aValue === 'string') {
              return this.sortOrder === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            }
            return this.sortOrder === 'asc' ? aValue - bValue : bValue - aValue;
          });
        },
        priceMax() {
          return this.products.length ? Math.max(...this.products.map(product => product.price)) : 1000;
        },
        weightMax() {
          return this.products.length ? Math.max(...this.products.map(product => product.weight)) : 50;
        }
      }
    });

    app.mount("#app");
  </script>
</body>
</html>
