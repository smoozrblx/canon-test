<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des Produits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="The tool is used to manipulate products" name="description">
  <meta content="Product" name="keywords">

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-100 text-gray-900">

  <div id="app" class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Gestion des Produits</h1>

    <div v-if="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      [[ errorMessage ]]
    </div>

    <div
    v-if="showFormModal"
    class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 relative z-50">
        <button
          @click="closeFormModal"
          class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
        >
          <i class="bi bi-x-lg"></i>
        </button>

        <h2 class="text-2xl font-semibold mb-6">
          [[ form.id ? "Modifier" : "Créer" ]] un produit
        </h2>

        <form @submit.prevent="form.id ? updateProduct() : createProduct()" class="space-y-6">
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Code produit</label>
              <input v-model="form.product_code" class="input w-full" placeholder="Code produit" maxlength="8" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Statut du produit</label>
              <select v-model="form.product_status" class="input w-full" required>
                <option disabled value="">-- Sélectionner --</option>
                <option class="text-green-600">EN VENTE</option>
                <option class="text-indigo-700">NOUVEAU</option>
                <option class="text-orange-500">EMBARGO</option>
                <option class="text-yellow-500">FIN DE VIE</option>
                <option class="text-red-800">OBSOLETE</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nom du produit</label>
              <input v-model="form.product_name" class="input w-full" placeholder="Nom du produit" maxlength="100" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prix (€)</label>
              <input v-model.number="form.price" type="number" step="0.01" class="input w-full" placeholder="Prix (€)" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Poids (kg)</label>
              <input v-model.number="form.weight" type="number" step="0.1" class="input w-full" placeholder="Poids (kg)">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date de sortie</label>
              <input v-model="form.release_date" type="date" class="input w-full" required>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Disponibilité</label>
              <select v-model="form.is_available" class="input w-full">
                <option :value="true">Disponible</option>
                <option :value="false">Indisponible</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Créé par</label>
              <input v-model="form.meta_entered_by" class="input w-full" placeholder="Créé par">
            </div>

          </div>

          <div class="flex justify-end space-x-3">
            <button
              type="submit"
              class="px-5 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 transition"
            >
              [[ form.id ? "Mettre à jour" : "Créer" ]] le produit
            </button>

            <button
              type="button"
              @click="closeFormModal"
              class="px-5 py-2 rounded-md bg-gray-200 text-gray-800 text-sm font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300 transition"
            >
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>


    <div class="overflow-x-auto bg-white shadow rounded">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100 text-left text-sm font-semibold text-gray-700">
          <tr>
            <th class="px-4 py-2">Statut</th>
            <th class="px-4 py-2">Code</th>
            <th class="px-4 py-2">Nom</th>
            <th class="px-4 py-2">Date de sortie</th>
            <th class="px-4 py-2">Disponibilité</th>
            <th class="px-4 py-2">Poids</th>
            <th class="px-4 py-2">Prix</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 text-sm">
          <tr v-for="product in products" :key="product.id">
            <td class="px-4 py-2">
              <span v-bind:class="{
                'bg-green-200 text-green-600': product.product_status === 'EN VENTE',
                'bg-indigo-200 text-indigo-700': product.product_status === 'NOUVEAU',
                'bg-orange-200 text-orange-500': product.product_status === 'EMBARGO',
                'bg-yellow-200 text-yellow-500': product.product_status === 'FIN DE VIE',
                'bg-red-200 text-red-800': product.product_status === 'OBSOLETE'
              }" class="inline-block px-3 py-1 rounded-full text-sm font-medium">
                [[ product.product_status ]]
              </span>
            </td>   
            <td class="px-4 py-2">
              <span class="inline-block bg-gray-100 text-gray-800 text-sm font-mono px-2 py-1 rounded-md">
                [[ product.product_code ]]
              </span>
            </td>

            <td class="px-4 py-2 text-sm font-medium text-gray-900">
              [[ product.product_name ]]
            </td>

            <td class="px-4 py-2 text-sm text-gray-700 flex items-center space-x-2">
              <i class="bi bi-calendar-event text-purple-600"></i>
              <span>
                [[ new Date(product.release_date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' }) ]]
              </span>
            </td>

            <td class="px-4 py-2">
              <span :class="product.is_available ? 'text-green-600' : 'text-red-500'" class="inline-flex items-center space-x-2">
                <i v-if="product.is_available" class="fas fa-check-circle text-green-600"></i>
                <i v-else class="fas fa-times-circle text-red-500"></i>
                <span>[[ product.is_available ? 'Disponible' : 'Indisponible' ]]</span>
              </span>
            </td>            
            <td class="px-4 py-2">
              <span class="inline-flex items-center bg-blue-100 text-blue-700 text-sm font-medium px-2 py-1 rounded">
                <i class="bi bi-box me-1"></i>
                [[ product.weight !== null && product.weight !== undefined ? product.weight + ' kg' : '–' ]]
              </span>
            </td>
            <td class="px-4 py-2">
              <span class="inline-flex items-center bg-green-100 text-green-700 text-sm font-semibold px-2 py-1 rounded">
                <i class="bi bi-currency-euro me-1"></i> [[ product.price ]] €
              </span>
            </td>
            <td class="px-4 py-2 space-x-2">
              <button
                @click="editProduct(product)"
                class="px-3 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
              >
                <i class="bi bi-pencil-fill mr-1"></i> Modifier
              </button>
            
              <button
                @click="deleteProduct(product.id)"
                class="px-3 py-1 rounded-md text-sm font-medium bg-red-100 text-red-700 hover:bg-red-200 transition"
              >
                <i class="bi bi-trash-fill mr-1"></i> Supprimer
              </button>
            </td>            
          </tr>
          <tr @click="openCreateForm" class="cursor-pointer hover:bg-blue-50 transition">
            <td colspan="999" class="text-center py-2">
              <div class="inline-flex items-center justify-center text-blue-600 text-md font-semibold">
                <i class="bi bi-plus-circle mr-2 text-2xl"></i>
                Ajouter un produit
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  


  <script>
    const app = Vue.createApp({
      delimiters: ['[[', ']]'],
      data() {
        return {
          products: [],
          errorMessage: '',
          showFormModal: false,
          form: {
            id: null,
            product_code: '',
            product_status: '',
            product_name: '',
            price: null,
            weight: null,
            release_date: '',
            is_available: true,
            meta_entered_by: ''
          }
        };
      },
      mounted() {
        this.fetchProducts();
      },
      methods: {
        async fetchProducts() {
          try {
            const response = await fetch("https://canontestexercise.azurewebsites.net/api/v1/product/");
            const data = await response.json();
            this.products = data;
          } catch (error) {
            this.errorMessage = "Erreur lors du chargement des produits.";
          }
        },
        async openCreateForm() {
          this.resetForm();
          this.showFormModal = true;
        },
        async createProduct() {
          this.errorMessage = '';
          try {
            const response = await fetch("https://canontestexercise.azurewebsites.net/api/v1/product/", {
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(JSON.stringify(errorData));
            }

            this.fetchProducts();
            this.resetForm();
          } catch (error) {
            this.errorMessage = "Erreur à la création: " + error.message;
          }
        },
        async updateProduct() {
          this.errorMessage = '';
          try {
            const response = await fetch(`https://canontestexercise.azurewebsites.net/api/v1/product/${this.form.id}/`, {
              method: "PUT",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.form)
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(JSON.stringify(errorData));
            }

            this.fetchProducts();
            this.resetForm();
          } catch (error) {
            this.errorMessage = "Erreur à la mise à jour: " + error.message;
          }
        },
        async deleteProduct(id) {
          if (!confirm("Supprimer ce produit ?")) return;

          this.errorMessage = '';
          try {
            const response = await fetch(`https://canontestexercise.azurewebsites.net/api/v1/product/${id}/`, {
              method: "DELETE"
            });

            if (!response.ok) {
              throw new Error("Échec de la suppression.");
            }

            this.fetchProducts();
          } catch (error) {
            this.errorMessage = "Erreur à la suppression: " + error.message;
          }
        },
        editProduct(product) {
          this.form = { ...product };
          this.showFormModal = true;
        },
        closeFormModal() {
          this.showFormModal = false;
        },
        resetForm() {
          this.form = {
            id: null,
            product_code: '',
            product_status: '',
            product_name: '',
            price: null,
            weight: null,
            release_date: '',
            is_available: true,
            meta_entered_by: ''
          };
          this.errorMessage = '';
        }
      }
    });

    app.mount("#app");
  </script>
</body>
</html>
